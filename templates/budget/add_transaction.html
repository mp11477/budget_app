{% extends 'base.html' %}
{% block title %}Add Transaction{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

  {# LEFT: form #}
  <section class="lg:col-span-7">
    <form method="post" class="space-y-3 max-w-2xl">
      <h1 class="text-center font-bold mb-5">Add New Transaction</h1>
      {% csrf_token %}
      {{ form.as_p }}

      <div class="flex justify-center gap-1">
        <button class="rounded-xl bg-[#113170] hover:bg-[#798A9A] text-white px-4 py-2 flex items-center gap-1" type="submit" name="save">
          <i class="material-icons text-green-600">save</i>
          <span>Save</span>
        </button>
        <button class="rounded-xl bg-[#113170] hover:bg-[#798A9A] text-white px-4 py-2 flex items-center gap-1" type="submit" name="save_and_add_another">
          <i class="material-icons text-green-600">add_box</i>
          <span>Save and Add Another</span>
        </button>
      </div>
    </form>
  </section>

  {# RIGHT: recent transactions panel (present at lg+ immediately) #}
  <aside id="recent-transactions-container"
        role="status" aria-live="polite"
        tabindex="0"
        class="lg:col-span-5 rounded-xl shadow p-4 hidden lg:block lg:sticky lg:top-8 
        text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
  <div class="text-gray-500">Select an account to see recent transactions…</div>
</aside>


</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const accountSelect = document.querySelector("select[name='account']");
  const container = document.getElementById("recent-transactions-container");

  function fetchRecentTransactions(accountId) {
  if (!accountId) return;

  // optional a11y hint
  container.setAttribute('aria-busy', 'true');
  container.innerHTML = '<div class="text-sm text-gray-500">Loading…</div>';

  fetch(`/transactions/recent/?account_id=${accountId}`)
    .then(r => r.json())
    .then(data => {
      container.innerHTML = data.html;
      container.removeAttribute('aria-busy');

      // move keyboard focus to the updated panel
      container.focus({ preventScroll: true });
    })
    .catch(() => {
      container.innerHTML = '<div class="text-sm text-red-600">Could not load recent transactions.</div>';
      container.removeAttribute('aria-busy');
      container.focus();
    });
}

  // Load immediately if an account is preselected
  if (accountSelect && accountSelect.value) {
    fetchRecentTransactions(accountSelect.value);
  }

  // Update on change
  if (accountSelect) {
    accountSelect.addEventListener("change", function () {
      fetchRecentTransactions(this.value);
    });
  }
});
</script>
{% endblock %}