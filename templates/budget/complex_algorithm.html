{% extends 'base.html' %}

{% block title %}Complex Algorithm{% endblock %}

{% block content %}
<div class="page-header flex-1 text-left">
  <h1 class="!text-left">Stef's Complex Algorithm</h1>

  <div class="controls flex justify-end">
    <label for="month-select">Jump to Month:</label>
    <select id="month-select" onchange="onMonthChange(this)">
        <option value="?month=" {% if not selected_month %}selected{% endif %}>All Months</option>
        {% for month in monthly_data reversed %}
            {% if not month.is_future %}
            <option value="?month={{ month.month }}" {% if month.is_selected %}selected{% endif %}>
                {{ month.month_name }}
            </option>
            {% endif %}
        {% endfor %}
       
    </select>

    <button id="toggle-dark" onclick="toggleDarkMode()">Toggle Dark Mode üåô</button>

    <div class="flex items-center">
        <input type="checkbox" id="toggleDormant" class="form-checkbox h-4 w-4" />
            <label for="toggleDormant" class="">Show dormant accounts</label>
    </div>
  </div>
</div>

{% for month in monthly_data %}
  {% if not month.is_future %}
    {% if selected_month == month.month or not selected_month %}
      <div class="month-section {% if month.is_selected %}selected{% endif %}">
        <h2 class="mt-20">{{ month.month_name }} {{ month.year }}</h2>
        <div class="flex flex-wrap gap-4">
        {% for account_data in month.accounts %}
          <div class="account-block flex-1 min-w-fit {% if account_data.is_dormant %}dormant-account{% endif %}">
            <div class="account-row {% if account_data.is_dormant %} collapsed dormant {% endif %}"></div>
            <h3 class="bg-[#8b8860] text-white rounded-xl">{{ account_data.account.name }}
                {% if account_data.is_dormant %}
                <em class="text-sm text-gray-500">(Dormant)</em>
            {% endif %}
            </h3>
            <table class="algo-data-row">
              <thead>
                <tr class="header-row">
                  <th>Date</th>
                  <th>Description</th>
                  <th>Debit</th>
                  <th>Credit</th>
                </tr>
              </thead>
              <tbody>
                {% for tx in account_data.transactions %}
                <tr class="">
                  <td class="">{{ tx.date }}</td>
                  <td class="">{{ tx.description }}</td>
                  <td class="">{% if tx.debit %}${{ tx.debit|floatformat:2 }}{% endif %}</td>
                  <td class="">{% if tx.credit %}${{ tx.credit|floatformat:2 }}{% endif %}</td>
                </tr>
                {% endfor %}
                <tr class="footer-row">
                    <td colspan="2" style="text-align: right;"><strong>Totals:</strong></td>
                    <td><strong>${{ account_data.debit|floatformat:2 }}</strong></td>
                    <td><strong>${{ account_data.credit|floatformat:2 }}</strong></td>
                  </tr>
              </tbody>
            </table>

            <div class="summary">
              <p><strong>Debits:</strong> ${{ account_data.debit|floatformat:2 }}</p>
              <p><strong>Credits:</strong> ${{ account_data.credit|floatformat:2 }}</p>
              <p><strong>Difference (Credits - Debits):</strong> ${{ account_data.computed_change|floatformat:2 }}</p>
              <p><strong>Start Balance:</strong> ${{ account_data.beginning_balance|floatformat:2 }}</p>
              <p><strong>End Balance:</strong> ${{ account_data.ending_balance|floatformat:2 }}</p>
              <p><strong>Change:</strong> ${{ account_data.actual_change|floatformat:2 }}</p>
              <p>{% if account_data.match %}‚úÖ Validated{% else %}‚ùå Mismatch detected!{% endif %}</p>
            </div>
          </div>
        {% endfor %}
        </div>

        <div class="month-summary w-72 mx-auto p-8 text-center bg-gray-300 box-border border-2 border-gray-400 rounded-lg shadow mt-6">
          <h4 class="font-bold text-lg">{{ month.month_name }} Overall Summary</h4>
          <p><strong>Total Debits:</strong> ${{ month.summary.total_debit|floatformat:2 }}</p>
          <p><strong>Total Credits:</strong> ${{ month.summary.total_credit|floatformat:2 }}</p>
          <p><strong>Difference (Credits - Debits):</strong> ${{ month.summary.computed_change|floatformat:2 }}</p>
          <p><strong>Total Start Balance:</strong> ${{ month.summary.total_start|floatformat:2 }}</p>
          <p><strong>Total End Balance:</strong> ${{ month.summary.total_end|floatformat:2 }}</p>
          <p><strong>Change:</strong> ${{ month.summary.actual_change|floatformat:2 }}</p>
          <p>{% if month.summary.match %}‚úÖ Validated{% else %}‚ùå Mismatch detected!{% endif %}</p>
          <hr>
        </div>
          <div class="ytd-block w-72 mx-auto p-8 text-center text-white bg-gray-700 box-border border-2 border-gray-400 rounded-lg shadow mt-6">
            <h4 class="font-bold text-lg">YTD Summary (Through {{ month.month_name }})</h4>
            <p><strong>YTD Debits:</strong> ${{ month.ytd_summary.debit|floatformat:2 }}</p>
            <p><strong>YTD Credits:</strong> ${{ month.ytd_summary.credit|floatformat:2 }}</p>
            <p><strong>YTD Difference:</strong> ${{ month.ytd_summary.diff|floatformat:2 }}</p>
          </div>
        </div>

        <hr class="month-divider">
      </div>
    {% endif %}
  {% endif %}
{% endfor %}

<script>
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const tables = document.querySelectorAll('table');
  tables.forEach(table => table.classList.toggle('dark-table'));
}

function onMonthChange(select) {
  const selected = select.value;
  window.location.href = selected;
}

document.addEventListener("DOMContentLoaded", function () {
    const checkbox = document.getElementById("toggleDormant");
    const dormantBlocks = document.querySelectorAll(".dormant-account");

    function updateVisibility() {
      const show = checkbox.checked;
      dormantBlocks.forEach(el => {
        el.style.display = show ? "block" : "none";
      });
    }

    // Default: hide dormant accounts
    updateVisibility();

    // Toggle on change
    checkbox.addEventListener("change", updateVisibility);
  });
</script>

<style>

  .navbar a.active {
    background-color: #ffffff22;
    border: 1px solid white;
  }
  .dark-mode table tr:nth-child(even) {
    background-color: #2e2e2e;
  }
  .dark-mode table tr:nth-child(odd) {
    background-color: #1f1f1f;
  }
  
</style>
{% endblock %}
