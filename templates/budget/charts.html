{% extends 'base.html' %}
{% block title %}Spending Charts{% endblock %}

{% block content %}
<!-- Load Chart.js + DataLabels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap"></script>


<h1>Spending Charts</h1>

<!-- ðŸŸ¦ BAR CHART: Total Monthly Spend -->
<section style="margin-bottom: 50px;">
  <h2>Total Monthly Spend</h2>
  <canvas id="spendChart" width="800" height="400"></canvas>
  {{ monthly_labels|json_script:"monthly-labels-data" }}
  {{ monthly_data|json_script:"monthly-spend-data" }}
  <p style="text-align:center; font-weight: bold;">
    Total Spend: {{ total_spend }}
  </p>
  <!-- ðŸ’¡ Total Monthly Spend Reference Card -->
  <div class="mt-8 bg-white shadow-md rounded-xl overflow-hidden border border-gray-200">
    <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-800">ðŸ’° Total Monthly Spend Reference</h3>
      <p class="text-sm text-gray-600">Understand what total spend represents in your chart.</p>
    </div>
    <div class="table-auto overflow-x-auto">
      <table class="min-w-full text-sm text-left text-gray-700">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-6 py-3 font-medium">Metric</th>
            <th class="px-6 py-3 font-medium">Definition</th>
            <th class="px-6 py-3 font-medium">Excludes</th>
            <th class="px-6 py-3 font-medium">Purpose / Meaning</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-100">
          <tr>
            <td class="px-6 py-4 font-semibold text-gray-900">Total Spend</td>
            <td class="px-6 py-4">Monthly expenses</td>
            <td class="px-6 py-4">Transfers between accounts, refunds/returns are not reversed and credit card payments are excluded</td>
            <td class="px-6 py-4">Gross spending (thus the reason no reversal on returns) for the month. </td>
          </tr>
          
      </table>
    </div>
  </div>
</section>

<!-- ðŸŸ¢ DOUGHNUT CHART: Spend by Deposit Account -->
<section style="display: flex; flex-direction: column; align-items: center; margin-bottom: 80px;">
  <h2 style="text-align: center;">Spend by Account</h2>

  {{ account_labels|json_script:"account-labels-data" }}
  {{ account_data|json_script:"account-data" }}

  <div style="
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    width: 600px;
    height: 400px;
    padding-bottom: 60px;  /* <-- Add this */
  ">
    <canvas id="accountChart" width="600" height="400"></canvas>

    <!-- Centered text in donut hole -->
    <div style="
      position: absolute;
      top: 33%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      pointer-events: none;
    ">
      {{ total_spend }}
    </div>
  </div>
</section>

<!-- Spend by Category Treemap -->
<section>
  <h2>Spend by Category</h2>
  <canvas id="categoryTreemap" width="800" height="500"></canvas>
  {{ treemap_labels|json_script:"treemap-labels-data" }}
  {{ treemap_data|json_script:"treemap-data" }}
  <p style="text-align: center; font-weight: bold;">
    Total Spend: {{ total_spend }}
  </p>
</section>

<!-- ðŸŸ£ LINE CHART: Spend by Category by Month -->
<section style="margin-top: 60px;">
  <h2>Spend by Category by Month</h2>
  <canvas id="lineChart" width="800" height="400"></canvas>
  {{ line_labels|json_script:"line-labels-data" }}
  {{ line_data|json_script:"line-data" }}
  <p style="text-align: center; font-weight: bold;">
    Total Spend: {{ total_spend }}
  </p>
</section>
 
<!-- ðŸŸ  PIE CHART: Spend Percent by Category -->
<section style="display: flex; flex-direction: column; align-items: center; margin-bottom: 80px;">
  <h2 style="text-align: center;">Spend by Category</h2>
  
  {{ pie_labels|json_script:"pie-labels-data" }}
  {{ pie_data|json_script:"pie-data" }}
  
  
  <div style="
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    width: 600px;
    height: 400px;
    padding-bottom: 20px;  /* <-- Add this */
  ">
    <canvas id="pieChart" width="600" height="400"></canvas>   
  </div>
  <p style="text-align: center; font-weight: bold;">
    Total Spend: {{ total_spend }}
  </p>
</section>


<!-- ðŸŸ© LINE/BAR CHART: Net Monthly Cash Flow -->
<section style="margin-bottom: 50px;">

  <h2>Net Monthly Cash Flow</h2>
  
  <!-- âœ… DATA MUST BE BEFORE CANVAS/JS -->
  {{ net_labels|json_script:"net_labels" }}
  {{ net_income_data|json_script:"net_income_data" }}
  {{ net_expense_data|json_script:"net_expense_data" }}
  {{ net_debt_data|json_script:"net_debt_data" }}
  {{ net_cash_data|json_script:"net_cash_data" }}
  {{ liquidity_data|json_script:"liquidity_data" }}
  {{ balance_labels|json_script:"balance_labels" }}
  {{ start_balances|json_script:"start_balances" }}
  {{ end_balances|json_script:"end_balances" }}

  

  <canvas id="netCashFlowChart" height="100"></canvas>
  
  
</section>


<!-- ðŸŸ£ Debt Pay Down: Balance + Payments
<section style="margin-top: 80px;">
  <h2>Credit Card Balance + Payments</h2>
  <canvas id="debtComboChart" width="800" height="400"></canvas>
  
  {{ debt_labels|json_script:"debt-labels-data" }}
  {{ debt_data|safe|json_script:"debt-data" }}
  {{ payment_data|safe|json_script:"payment-data" }}
  
 </section>

 <p style="color: darkred; font-weight: bold;">
  ðŸ§ª Debt Chart First Value (Debug): {{ debt_data|first }}
</p> -->

<script>
  // Register ChartDataLabels once (do not use Chart.register globally again)
  const monthlyLabels = JSON.parse(document.getElementById("monthly-labels-data").textContent);
  const monthlyData = JSON.parse(document.getElementById("monthly-spend-data").textContent);

  const spendCtx = document.getElementById('spendChart').getContext('2d');
  new Chart(spendCtx, {
    type: 'bar',
    data: {
      labels: monthlyLabels,
      datasets: [{
        label: 'Total Spend ($)',
        data: monthlyData,
        backgroundColor: 'rgba(75, 192, 192, 0.5)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1,
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString();
            }
          }
        }
      }
    }
  });

  // Doughnut chart
  const accountLabels = JSON.parse(document.getElementById("account-labels-data").textContent);
  const accountData = JSON.parse(document.getElementById("account-data").textContent);
  const accountCtx = document.getElementById("accountChart").getContext("2d");

  new Chart(accountCtx, {
  type: 'doughnut',
  data: {
    labels: accountLabels,
    datasets: [{
      label: 'Spend by Account',
      data: accountData,
      backgroundColor: [
        'rgba(255, 99, 132, 0.5)',
        'rgba(54, 162, 235, 0.5)',
        'rgba(255, 206, 86, 0.5)',
        'rgba(75, 192, 192, 0.5)',
        'rgba(153, 102, 255, 0.5)'
      ],
      borderColor: [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)'
      ],
      borderWidth: 1
    }]
  },
  options: {
    responsive: false,
    layout: {
      padding: {
        bottom: 20  // pushes the whole chart (including labels) up slightly
      }
    },
    plugins: {
      datalabels: {
        color: '#000',
        font: {
          weight: 'bold'
        },
        align: function(context) {
          // Push label outside if slice is small
          const value = context.dataset.data[context.dataIndex];
          const total = context.dataset.data.reduce((a, b) => a + b, 0);
          const percent = value / total;
          return percent < 0.06 ? 'end' : 'center';
        },
        anchor: function(context) {
          const value = context.dataset.data[context.dataIndex];
          const total = context.dataset.data.reduce((a, b) => a + b, 0);
          const percent = value / total;
          return percent < 0.06 ? 'end' : 'center';
        },
        formatter: (value, context) => {
          const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
          const percentage = (value / total * 100).toFixed(1);
          const currency = "$" + value.toFixed(2);
          return `${currency}\n${percentage}%`;
        }
      
      },
      tooltip: {
        callbacks: {
          label: function(context) {
          const value = context.raw;
          const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
          const percent = ((value / total) * 100).toFixed(1);
          return `${context.label}: $${value.toFixed(2)} (${percent}%)`;
          }
        }
      },
      legend: {
        position: 'bottom',
        labels: {
          boxWidth: 20,
          padding: 20
        }
      }
    }
  },
  plugins: [ChartDataLabels]
});

// Treemap Chart (using Chart.js Treemap plugin)
const treemapLabels = JSON.parse(document.getElementById("treemap-labels-data").textContent);
const treemapData = JSON.parse(document.getElementById("treemap-data").textContent);

// Convert to Chart.js format
const treemapFormattedData = treemapLabels.map((category, index) => ({
  x: 0,
  y: 0,
  v: treemapData[index],
  g: category,  // Use "g" key so "groups: ['g']" works
}));

new Chart(document.getElementById('categoryTreemap').getContext('2d'), {
  type: 'treemap',
  data: {
    datasets: [{
      tree: treemapFormattedData,
      key: 'v',
      groups: ['g'],  // Use 'g' as the label source
      backgroundColor: (ctx) => {
        const colors = ['#8ecae6', '#219ebc', '#023047', '#ffb703', '#fb8500'];
        return colors[ctx.index % colors.length];
      },
      labels: {
        display: true,
        formatter: (ctx) => {
          return `${ctx.raw.g}\n$${ctx.raw.v.toFixed(2)}`;  // Now using "g" instead of "label"
        },
        color: 'white',
        font: {
          weight: 'bold'
        }
      }
    }]
  },
  options: {
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          title: (ctx) => ctx[0].raw.g,  // Tooltip title is category
          label: (ctx) => `$${ctx.raw.v.toFixed(2)}`
        }
      }
    }
  }
});

// Line Chart for Spend by Category by Month
  const lineLabels = JSON.parse(document.getElementById("line-labels-data").textContent);
  const lineData = JSON.parse(document.getElementById("line-data").textContent);

  const lineCtx = document.getElementById("lineChart").getContext("2d");

  const datasets = Object.entries(lineData).map(([category, data]) => ({
    label: category,
    data: data,
    borderWidth: 2,
    fill: false,
    tension: 0.3
  }));

  new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: lineLabels,
      datasets: datasets
    },
    options: {
      responsive: true,
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      },
      plugins: {
        legend: {
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => `$${value}`
          }
        }
      }
    }
  });

// Pie Chart
const pieLabels = JSON.parse(document.getElementById("pie-labels-data").textContent);
const pieData = JSON.parse(document.getElementById("pie-data").textContent);
const totalPie = pieData.reduce((a, b) => a + b, 0);

new Chart(document.getElementById("pieChart").getContext("2d"), {
  type: 'pie',
  data: {
    labels: pieLabels,
    datasets: [{
      data: pieData,
      backgroundColor: pieLabels.map((_, i) => `hsl(${i * 47 % 360}, 65%, 65%)`),
      borderWidth: 1
    }]
  },
  options: {
    responsive: false,
    layout: {
      padding: {
        bottom: 5,  // pushes the whole chart (including labels) up slightly
        top: 50
      }
    },
    plugins: {
      datalabels: {
        display: false  // ðŸ‘ˆ turn off slice labels entirely
      },
      legend: {
        position: 'bottom',
        labels: {
          boxWidth: 20,
          padding: 20
        }
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            const value = context.raw;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percent = ((value / total) * 100).toFixed(1);
            const category = context.label;

            return `$${value.toFixed(2)} (${percent}%)`;
            
          },
          labelTextColor: () => '#000'  // darker tooltip text for readability
        },
        titleFont: { weight: 'bold' },
        bodyFont: { weight: 'bold' },
        backgroundColor: '#f5f5f5',
        titleColor: '#333',
        bodyColor: '#333',
        borderColor: '#ccc',
        borderWidth: 1
      },
    },
  },
  plugins: [ChartDataLabels]
});

// ðŸ”´ Net Monthly Cash Flow

const balanceLabels = JSON.parse(document.getElementById("balance_labels").textContent);
const startBalances = JSON.parse(document.getElementById("start_balances").textContent);
const endBalances = JSON.parse(document.getElementById("end_balances").textContent);

console.log("Starting Balance", startBalances);
console.log("Ending Balance", endBalances)
  

if (document.getElementById("net_labels")) {
  const netLabels = JSON.parse(document.getElementById("net_labels").textContent);
  const netIncome = JSON.parse(document.getElementById("net_income_data").textContent);
  const netExpenses = JSON.parse(document.getElementById("net_expense_data").textContent);
  const debtPayments = JSON.parse(document.getElementById("net_debt_data").textContent);
  const netCashFlow = JSON.parse(document.getElementById("net_cash_data").textContent);
  const liquidity = JSON.parse(document.getElementById("liquidity_data").textContent);

  const ctxNet = document.getElementById("netCashFlowChart").getContext("2d");

  console.log("Income:", netIncome);
  console.log("Expenses:", netExpenses);
  console.log("Net Cash Flow:", netCashFlow);
  
  new Chart(ctxNet, {
  type: "bar",
  data: {
    labels: netLabels,
    datasets: [
      {
        label: "True Liquidity",
        data: liquidity,
        backgroundColor: "darkgreen",
        datalabels: {
          anchor: 'end',
          align: 'top',
          formatter: val => `$${val.toFixed(0)}`
        }
      },
      {
        label: "Net Cash Flow",
        data: netCashFlow,
        backgroundColor: "green",
      },
      {
        label: "Income",
        data: netIncome,
        type: "line",
        borderColor: "blue",
        borderWidth: 2,
        fill: false
      },
      {
        label: "Expenses",
        data: netExpenses,
        type: "line",
        borderColor: "orange",
        borderWidth: 2,
        fill: false
      },
      {
        label: "Debt Payments",
        data: debtPayments,
        type: "line",
        borderColor: "purple",
        borderWidth: 2,
        fill: false
      },
      {
      label: "Starting Balance",
      data: startBalances,
      type: "line",
      borderColor: "rgba(0, 123, 255, 0.8)", // Blue
      backgroundColor: "transparent",
      borderWidth: 2,
      tension: 0.3,
      pointRadius: 4,
      pointHoverRadius: 6,
      fill: false
    },
    {
      label: "Ending Balance",
      data: endBalances,
      type: "line",
      borderColor: "rgba(40, 167, 69, 0.8)", // Green
      backgroundColor: "transparent",
      borderWidth: 2,
      tension: 0.3,
      pointRadius: 4,
      pointHoverRadius: 6,
      fill: false
    }
    ],
   
  },
  
  options: {
    plugins: {
      datalabels: {
        color: '#000',
        font: { size: 10, weight: 'bold' },
        display: function(context) {
          // Only show labels for the bar datasets
          return context.dataset.type !== 'line';
        },
        formatter: function(value, context) {
          if (context.dataset.label === 'True Liquidity') {
            return `$${value.toFixed(0)}`;
          } else if (context.dataset.label === 'Net Cash Flow') {
            return `$${value.toFixed(0)}`;
          } else {
            return '';  // skip other lines
          }
        }
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            const index = context.dataIndex;
            const label = context.dataset.label;
            const value = context.dataset.data[index];
            return `${label}: $${value.toFixed(2)}`;
          }
        }
      },
      legend: {
        position: 'top'
      },
    },
    scales: {
      y: {
        beginAtZero: true
      },
      x: {
        ticks: {
          maxRotation: 45,
          minRotation: 45
        }
    }
  },
  },
  plugins: [ChartDataLabels]
});
  }

</script>
<section style="margin-top: 40px;">
  <h2>Deposit Account Balances by Month</h2>
  <table style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr style="border-bottom: 2px solid #ccc;">
        <th style="text-align: left; padding: 8px;">Month</th>
        <th style="text-align: right; padding: 8px;">Starting Balance</th>
        <th style="text-align: right; padding: 8px;">Ending Balance</th>
      </tr>
    </thead>
    <tbody>
      {% for month, balance in monthly_balances.items %}
        <tr>
          <td style="padding: 8px;">{{ month }}</td>
          <td style="text-align: right; padding: 8px;">${{ balance.start|floatformat:2 }}</td>
          <td style="text-align: right; padding: 8px;">${{ balance.end|floatformat:2 }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<!-- ðŸ’¡ Net Cash Flow Summary Reference Card -->
<div class="mt-8 bg-white shadow-md rounded-xl overflow-hidden border border-gray-200">
  <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
    <h3 class="text-lg font-semibold text-gray-800">ðŸ’° Net Cash Flow Summary Reference</h3>
    <p class="text-sm text-gray-600">Understand what each metric represents in your chart.</p>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm text-left text-gray-700">
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <th class="px-6 py-3 font-medium">Metric</th>
          <th class="px-6 py-3 font-medium">Definition</th>
          <th class="px-6 py-3 font-medium">Excludes</th>
          <th class="px-6 py-3 font-medium">Purpose / Meaning</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        <tr>
          <td class="px-6 py-4 font-semibold text-gray-900">Income</td>
          <td class="px-6 py-4">All money received (credits)</td>
          <td class="px-6 py-4">None</td>
          <td class="px-6 py-4">Total earned or received money for the month</td>
        </tr>
        <tr>
          <td class="px-6 py-4 font-semibold text-gray-900">Expenses</td>
          <td class="px-6 py-4">All money spent, where <code>is_expense=True</code></td>
          <td class="px-6 py-4">Debt payments</td>
          <td class="px-6 py-4">Cost of living, discretionary and necessary spending (Net Spend, so refunds are added back in)</td>
        </tr>
        <tr>
          <td class="px-6 py-4 font-semibold text-gray-900">Net Cash Flow</td>
          <td class="px-6 py-4"><code>Income - Expenses</code></td>
          <td class="px-6 py-4">Debt payments</td>
          <td class="px-6 py-4">Pre-debt surplus or deficit each month</td>
        </tr>
        <tr>
          <td class="px-6 py-4 font-semibold text-gray-900">Debt Payments</td>
          <td class="px-6 py-4">Credit-side payments to credit cards</td>
          <td class="px-6 py-4">Expenses</td>
          <td class="px-6 py-4">How much cash went to reducing card balances</td>
        </tr>
        <tr>
          <td class="px-6 py-4 font-semibold text-gray-900">True Liquidity</td>
          <td class="px-6 py-4"><code>Net Cash Flow - Debt Payments</code></td>
          <td class="px-6 py-4">None</td>
          <td class="px-6 py-4">Actual cash left after all obligations are paid</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
