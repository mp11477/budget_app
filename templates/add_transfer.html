{% extends 'base.html' %}
{% block title %}Add Transfer{% endblock %}
{% block content %}

<h1>Add New Transfer</h1>

<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

  {# LEFT: form #}
  <section class="lg:col-span-7">
    <form method="post" class="space-y-6 max-w-2xl">
      {% csrf_token %}
      {{ form.as_p }}

      <div class="flex justify-center gap-3">
        <button class="rounded-xl bg-[#113170] hover:bg-[#798A9A] text-white px-4 py-2 flex items-center gap-1" type="submit" name="save">
          <i class="material-icons text-green-600">swap_horiz</i>
          <span>Save</span>
        </button>
        <button class="rounded-xl bg-[#113170] hover:bg-[#798A9A] text-white px-4 py-2 flex items-center gap-1" type="submit" name="save_and_add_another">
          <i class="material-icons text-green-600">add</i>
          <span>Save & Add Another</span>
        </button>
      </div>
    </form>
  </section>

  {# RIGHT: recents for the FROM account #}
  <aside id="recent-transfers-panel"
         role="status" aria-live="polite" tabindex="0"
         class="lg:col-span-5 shadow rounded-xl p-4 hidden lg:block lg:sticky lg:top-8 text-sm
                focus:outline-none focus:ring-2 focus:ring-blue-400">
    <div class="text-gray-500">Select a “From account” to see recent transactions…</div>
  </aside>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const fromSelect = document.querySelector("select[name='from_account']");
  const panel = document.getElementById("recent-transfers-panel");

  function loadRecents(accountId) {
    if (!accountId) return;
    panel.setAttribute('aria-busy', 'true');
    panel.innerHTML = '<div class="text-gray-500">Loading…</div>';

    // Reuse your existing endpoint; change URL if yours differs
    fetch(`/transactions/recent/?account_id=${accountId}`)
      .then(r => r.json())
      .then(data => {
        panel.innerHTML = data.html;
        panel.removeAttribute('aria-busy');
        panel.focus({ preventScroll: true }); // visible ring due to focus classes
      })
      .catch(() => {
        panel.innerHTML = '<div class="text-red-600">Could not load recent transactions.</div>';
        panel.removeAttribute('aria-busy');
        panel.focus({ preventScroll: true });
      });
  }

  if (fromSelect && fromSelect.value) {
    loadRecents(fromSelect.value);
  }
  if (fromSelect) {
    fromSelect.addEventListener("change", function () {
      loadRecents(this.value);
    });
  }
});
</script>
{% endblock %}